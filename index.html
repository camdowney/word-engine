<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <title>Word Engine</title>
  <meta name='description' content='Word Engine by Cameron Downey'>
  <link rel='stylesheet' href='./style.css'>
</head>
<body>
  <header></header>
  <main></main>
  <footer></footer>
</body>
</html>
<script type='module'>
  import { render } from './min.js'
  import { isLetter, chunk } from './util.js'
  import Board from './components/Board.js'
  import Suggestions from './components/Suggestions.js'
  import Counter from './components/Counter.js'

  const NUM_CELLS = 30
  let cells = []

  const app = document.querySelector('main')
  const layout = render(app, 
    { a: 'section', class: 'split' , c: [
      { a: Board, cells, updateCellState },
      { a: Suggestions },
      { a: Counter },
    ]}
  )
  window.addEventListener('keydown', updateLetters)

  function updateCellState(e) {
    const index = e.srcElement.dataset.index
    if (!cells[index]) return
    cells[index].state = (cells[index].state + 1) % 3
    updateUI()
  }

  function updateLetters(e) {
    const key = e.key.toLowerCase()

    if (key === 'backspace' && cells.length > 0) {
      cells.pop()
      updateUI()
    }
    else if (!e.repeat && isLetter(key) && cells.length < NUM_CELLS) {
      cells.push({ letter: key, state: 0 })
      updateUI()
    }
  }

  function updateUI() {
    const filters = getFilters()
    render(true, { a: Board, cells, updateCellState })
    render(true, { a: Suggestions, filters })
  }

  function getFilters() {
    let filters = {
      minLetterCount: {},
      maxLetterCount: {},
      notHasLetterAt: [[], [], [], [], []],
      hasLetterAt: [[], [], [], [], []],
    }

    const rows = chunk(cells, 5).filter(row => Array.isArray(row))
    
    cells.forEach((cell, index) => {
      const { letter, state } = cell
      const row = Math.floor(index / 5)
      const col = index % 5
      const validCountInRow = rows[row]?.filter(c => c.state > 0 && c.letter === letter).length

      if (state > 0)
        filters.minLetterCount[letter] = validCountInRow
      else
        filters.maxLetterCount[letter] = validCountInRow

      if (state === 2)
        filters.hasLetterAt[col].push(letter)
      else
        filters.notHasLetterAt[col].push(letter)
    })

    return filters
  }
</script>